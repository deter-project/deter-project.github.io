<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Writing Your Own MAGI Agents - DETERLab Docs</title>
  

  <link rel="shortcut icon" href="../../favicon.ico">
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../css/extra.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Writing Your Own MAGI Agents";
    var mkdocs_page_input_path = "orchestrator/writing-agents.md";
    var mkdocs_page_url = "/orchestrator/writing-agents/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">
<!--
	<header>
		<h1 class="logo"><a href="/">DETERLab Docs</a></h1>
	</header>
-->
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon"><img class="logo" style="float:left" src="/img/doc-logo.png"/> <span class="title">DETERLab Docs</span></a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Welcome to the DETERLab Documentation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../glossary/">Glossary</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>DETERLab Core</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/core-quickstart/">Core Quickstart</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/core-guide/">Core Guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/sample-topologies/">Sample Topologies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/using-nodes/">Using Your Nodes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/generating-traffic/">Generating Traffic</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/link-delays/">End Node Traffic Shaping</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/sharing/">Using Shared Materials</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Core Reference</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/deterlab-commands/">DETERLab Commands</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/ns-commands/">NS Commands Extensions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/swapping/">Understanding Swapping (Node Use Policies)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/DETERSSH/">Accessing testbeds using SSH</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/node-types/">DETERLab Node Types</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/serial-console/">Using the Serial Console</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/dell-serial-console/">Dell Serial Console</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/os-images/">OS Images</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/custom-images/">Creating Custom Images</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/windows/">Windows XP</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/legacy-tools/">Legacy Tools</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Orchestrator</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../orchestrator-quickstart/">Orchestrator Quickstart</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../orchestrator-guide/">Orchestrator Guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../orchestrator-case-studies/">Orchestrator Case Studies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../simple-client-server/">Simple Client Server Case Study</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../scaled-client-server/">Scaled Client Server Case Study</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../feedback/">Feedback Case Study</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Writing Your Own MAGI Agents</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#basic-agent-information">Basic Agent Information</a></li>
                
            
                <li class="toctree-l3"><a href="#dispatchagent-class">DispatchAgent class</a></li>
                
            
                <li class="toctree-l3"><a href="#basic-elements-of-writing-a-client">Basic Elements of Writing a Client</a></li>
                
            
                <li class="toctree-l3"><a href="#deploying-and-executing-a-sample-agent">Deploying and Executing a Sample Agent</a></li>
                
                    <li><a class="toctree-l4" href="#step-1-create-a-local-directory-named-filecreator">Step 1: Create a local directory named “FileCreator”</a></li>
                
                    <li><a class="toctree-l4" href="#step-2-create-the-agent-implementation-code-file">Step 2: Create the Agent implementation code file</a></li>
                
                    <li><a class="toctree-l4" href="#step-3-create-the-idl-file">Step 3: Create the IDL file</a></li>
                
                    <li><a class="toctree-l4" href="#step-4-create-the-aal-file">Step 4: Create the AAL file</a></li>
                
                    <li><a class="toctree-l4" href="#step-5-run-orchestrator">Step 5: Run Orchestrator</a></li>
                
            
                <li class="toctree-l3"><a href="#runtime-agent-configuration">Runtime Agent Configuration</a></li>
                
            
                <li class="toctree-l3"><a href="#troubleshooting">Troubleshooting</a></li>
                
                    <li><a class="toctree-l4" href="#error-you-see-a-no-such-file-error">Error: You see a ‘No such file’ error</a></li>
                
                    <li><a class="toctree-l4" href="#error-you-see-a-no-attribute-getagent-message">Error: You see a “no attribute ‘getAgent’” message</a></li>
                
                    <li><a class="toctree-l4" href="#error-module-object-has-no-attribute-getagent">Error: 'module' object has no attribute 'getAgent'</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../agent-configuration/">Configuring a MAGI Agent at Runtime</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../orchestrator-reference/">Orchestrator Reference</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../system-files/">MAGI System Files</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../agent-library/">MAGI Agent Library</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../magi-tools/">MAGI Tools</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Containers</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../containers/containers-quickstart/">Containers Quickstart</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../containers/containers-guide/">Containers Guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../containers/containers-reference/">Containers Reference</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Other Features</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../federation/">Federation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../abac/">ABAC</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Miscellaneous</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../ISIUCB/">DETERLab Rooms</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>About</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../about/release-notes/">Release Notes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../about/contributing/">Contributing</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../about/license/">License</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">DETERLab Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <!--
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Orchestrator &raquo;</li>
        
      
    
    <li>Writing Your Own MAGI Agents</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
        -->
          <div role="navigation" aria-label="breadcrumbs navigation">
            <!--
            
              

                
                  <h1>Orchestrator &raquo;</h1>
                
              
            
          -->
            <h1>Writing Your Own MAGI Agents</h1>
          </div>
          <div role="main">
            <div class="section">
              
                <p>This page gives you a brief introduction on writing your own Magi Agent. It is designed to give you sample code, briefly explain it, then show you the pieces needed to run it. After reading this page you should be able to write and run a basic MAGI Agent. Further details and more advanced agent information may be found in the Magi Agent Library document (link).</p>
<h2 id="basic-agent-information">Basic Agent Information<a class="headerlink" href="#basic-agent-information" title="Permanent link"></a></h2>
<p>An Agent runs in two modes: a threaded mode and a process mode.</p>
<ul>
<li><strong>Threaded</strong> mode: The MAGI Daemon loads python codes directly, and runs the Agent in a thread in its own process space.</li>
<li><strong>Process</strong> mode: The MAGI Daemon runs the agent in a process space separate from itself and communicates with the Agent via a pipe or a socket.</li>
</ul>
<h2 id="dispatchagent-class"><code>DispatchAgent</code> class<a class="headerlink" href="#dispatchagent-class" title="Permanent link"></a></h2>
<p>In most cases you will want to use the Orchestrator (link) and an AAL file (link) to run and coordinate your Agent actions. In order to get the basic Agent control (via remote procedure calls), you’ll need to derive your agent from the <code>DispatchAgent</code> base class.</p>
<p>The <code>DispatchAgent</code> implements the simple remote procedure call (RPC) mechanism used by the Orchestrator (and available through the MAGI python API). This allows any method in a class derived from <code>DispatchAgent</code> to be invoked in an AAL (or by a MagiMessage if using the MAGI python interface directly). </p>
<p>The <code>DispatchAgent</code> code simply loops, parsing incoming messages, looking for an event message. When it finds one, it attempts to call the method specified in the message with the arguments given. You needn’t worry about message handling or parsing when you derive from <code>DispatchAgent</code>, you can simply write your code and call that code from the AAL.</p>
<h2 id="basic-elements-of-writing-a-client">Basic Elements of Writing a Client<a class="headerlink" href="#basic-elements-of-writing-a-client" title="Permanent link"></a></h2>
<p>To write and execute your agent you need the following three things:</p>
<ul>
<li>The Agent code to implement the Agent. Also, every Agent must implement a method named <code>getAgent</code> which returns an instance of the Agent to run. The MAGI Daemon uses this method to get an instance of the Agent to run in a local thread and communicate with the Agent instance.</li>
<li>An Interface Description Language (IDL) file to describe the Agent function and specify things the MAGI Daemon needs to know to load and execute the Agent code (among these is the location of the Agent code and the execution mode).</li>
<li>An AAL file (as described <a href="/orchestrator/orchestrator-guide/#step-1-write-the-aal-file">here</a>)</li>
</ul>
<h2 id="deploying-and-executing-a-sample-agent">Deploying and Executing a Sample Agent<a class="headerlink" href="#deploying-and-executing-a-sample-agent" title="Permanent link"></a></h2>
<h3 id="step-1-create-a-local-directory-named-filecreator">Step 1: Create a local directory named “FileCreator”<a class="headerlink" href="#step-1-create-a-local-directory-named-filecreator" title="Permanent link"></a></h3>
<p>MAGI Agents are usually contained in a single directory.</p>
<h3 id="step-2-create-the-agent-implementation-code-file">Step 2: Create the Agent implementation code file<a class="headerlink" href="#step-2-create-the-agent-implementation-code-file" title="Permanent link"></a></h3>
<p>Copy the following Agent implementation code to the file “FileCreator/FileCreator.py”.</p>
<p>This example Agent code has the following characteristics:</p>
<ul>
<li>It creates a simple Agent which creates a single file on a host.</li>
<li>The agent is called FileCreator.</li>
<li>It has a single method, <code>createFile</code>, which creates the file <code>/tmp/newfile</code> when called</li>
<li>For this agent, we will always run in threaded-mode.</li>
</ul>
<pre><code>
    from magi.util.agent import DispatchAgent, agentmethod

    # the getAgent() method must be defined somewhere for all agents.
    # The Magi daemon invokes this mehod to get a reference to an
    # agent. It uses this reference to run and interact with an agent
    # instance. (The cotangent() call is generally the same for all agent
    # implementations: it just returns an instance of the agent.)
    def getAgent():
        return FileCreator()

    # The FileCreator agent implementation, derived from DispatchAgent.
    class FileCreator(DispatchAgent):
        def __init__(self):
            DispatchAgent.__init__(self)
            self.filename = '/tmp/newfile'

        # A single method which creates the file named by self.filename.
        # (The @agentmethod() decorator is not required, but is encouraged.
        #  it does nothing of substance now, but may in the future.)
        @agentmethod()
        def createFile(self, msg):
            **Create a file on the host.**
            # open and immediately close the file to create it.
            open(self.filename, 'w').close()

</code></pre>

<h3 id="step-3-create-the-idl-file">Step 3: Create the IDL file<a class="headerlink" href="#step-3-create-the-idl-file" title="Permanent link"></a></h3>
<p>Copy the IDL below to a file named “FileCreator/FileCreator.idl”. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The file and directory may be named anything, but if you deviate from the naming scheme given, make sure the mainfile setting in the IDL and the code setting in your AAL (below) matches your naming scheme.</p>
</div>
<p>The following example IDL file has the following characteristics:</p>
<ul>
<li>The execution mode is “thread” and the inheritance is specified as “DispatchAgent”.</li>
<li>When you run this, you must specify the name of your implementation file (i.e., the Agent code from the previous step). This example assumes the file is in the local directory and is named “FileCreator.py”.</li>
<li>It lists methods and internal variables that the author wants exposed to external configuration. In our case, we expose the variable <code>filename</code>, but currently only use the default setting. Later we will describe how to set this outside of the Agent implementation.</li>
</ul>
<pre><code>    name: FileCreator
    display: File Creator Agent
    description:  This agent creates a file on the test node.
    execute: thread
    mainfile: FileCreator.py
    inherits:
       - DispatchAgent

    methods:
       - name: createFile
         help: Create the file
         args: []

    variables:
       - name: filename
         help: the full path of the file to create
         type: string
</code></pre>

<h3 id="step-4-create-the-aal-file">Step 4: Create the AAL file<a class="headerlink" href="#step-4-create-the-aal-file" title="Permanent link"></a></h3>
<p>Copy the sample AAL code below to a file named “FileCreator/myEvents.aal”.</p>
<p>Make sure to:</p>
<ul>
<li>Replace <code>PATH</code> with the full path to your “FileCreator” directory. Note: the PATH you use must include the NFS-mounted location on the test nodes. </li>
<li>Replace <code>NODES</code> with the comma-separated list of nodes on your testbed on which you want to run the Agent.</li>
</ul>
<pre><code>    streamstarts: [main]

    groups:
        myFileCreatorGroup [NODES]

    agents:
        myFileCreators:
            group: myFileCreatorGroup
            # (note: the &quot;code&quot; argument is the Agent directory. The
            # directory must contain an IDL and Agent implementation.)
            code: PATH/FileCreator
            execargs: []

    eventstreams:
        main:
            - type: event
              agent: myFileCreators
              method: createFile
              args: { }

</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>The AAL is in YAML format; therefore, it cannot have tabs. If you cut and paste the above code, make sure to remove any possible inserted tabs.</li>
<li>Because your Agent code is on an NFS-mounted filesystem, all MAGI Daemons may read the code directly.</li>
</ul>
</div>
<h3 id="step-5-run-orchestrator">Step 5: Run Orchestrator<a class="headerlink" href="#step-5-run-orchestrator" title="Permanent link"></a></h3>
<p>Run the MAGI Orchestrator to run the event streams in your AAL file - and thus your agent code:</p>
<pre><code>magi_orchestrator --control $control --events myEvents.aal -o run.log -v
</code></pre>

<p>Where <code>$control</code> is the fully qualified domain of your DETERLab node, i.e. <code>myNode.myGroup.myProject</code>}</p>
<p>This command runs the Orchestrator, which connects to the <code>$control</code> node, runs the events in the <strong>myEvents.aal</strong> file and writes verbose output to <strong>run.log</strong>.</p>
<p>In this example, the method <code>createFile</code> will be called on all test nodes associated with <code>myAgentGroup</code> in the AAL file.</p>
<p>On standard out, you should see Orchestrator output similar to the following:</p>
<pre><code>stream initialization : sent : joinGroup myFileCreatorGroup --&gt; __ALL__
stream initialization : done : trigger GroupBuildDone myFileCreatorGroup  complete.
stream initialization : sent : loadAgent myFileCreators --&gt; myFileCreatorGroup
stream initialization : done : trigger AgentLoadDone  myFileCreators complete.
stream initialization : DONE : complete.
stream main           : sent : createFile(None) --&gt; myFileCreatorGroup
stream main           : DONE : complete.

</code></pre>

<p>This output shows the two execution streams the orchestrator runs. The first, <em>initialization</em>, is internal to the Orchestrator and sets up group communication and loads the agents. The second, <em>main</em>, is the event stream specified in your AAL file.</p>
<p>If you do not see the “correct” output above, refer to the [#troubleshooting Troubleshooting] section below. </p>
<p>To confirm the Agent ran and executed the <code>createFile</code> method, run the following (from <code>users</code>):</p>
<pre><code>ssh myNode.myExperiment.myGroup ls -l /tmp/newfile
</code></pre>

<p>Where <code>myNode.myExperiment.myGroup</code> is the domain name of a node on which you executed the Agent.</p>
<p>You may download the sample code as a tar file here: [FileCreator.tbz] (attach).</p>
<h2 id="runtime-agent-configuration">Runtime Agent Configuration<a class="headerlink" href="#runtime-agent-configuration" title="Permanent link"></a></h2>
<p>The sample Agent <code>FileCreator</code> always creates the same file, each time it is run. What if you wanted to create a different file? Or a series of files? It is possible to specify Agent configuration in an AAL file - configuration that can modify the internal variables of your Agent at run time. See <a href="/orchestrator/agent-configuration/">MAGI Agent Configuration</a> for details.</p>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link"></a></h2>
<p>Look at the Magi Daemon log file at <code>/var/log/magi/daemon.log</code> on your control and test nodes looking for errors. If there are syntax errors in Agent execution, they may show up here.</p>
<h3 id="error-you-see-a-no-such-file-error">Error: You see a ‘No such file’ error<a class="headerlink" href="#error-you-see-a-no-such-file-error" title="Permanent link"></a></h3>
<p>You may see an error indicating there is no such file as follows:</p>
<pre><code>
Run-time exception in agent &lt;Daemon(daemon, started 140555403872000)&gt; on node(s) control in method __init__, line 71, in file threadInterface.py. Error: [Errno 2] No such file or directory

</code></pre>

<p><strong>Solution:</strong> You probably did not specify the correct “mainfile” in the IDL file. It must not be pathed out and must match the name of the main Agent implementation file, for example, “myAgent.py”.</p>
<h3 id="error-you-see-a-no-attribute-getagent-message">Error: You see a “no attribute ‘getAgent’” message<a class="headerlink" href="#error-you-see-a-no-attribute-getagent-message" title="Permanent link"></a></h3>
<p><strong>Solution:</strong> The Magi Daemon needs the well-known method <code>getAgent</code> to exist in the Agent module. Add it to your Agent code.</p>
<h3 id="error-module-object-has-no-attribute-getagent">Error: 'module' object has no attribute 'getAgent'<a class="headerlink" href="#error-module-object-has-no-attribute-getagent" title="Permanent link"></a></h3>
<p><strong>Solution:</strong> Make sure your agent defines (and exports or make available) a <code>getAgent</code> method and that it returns an instance of your agent.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../agent-configuration/" class="btn btn-neutral float-right" title="Configuring a MAGI Agent at Runtime"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../feedback/" class="btn btn-neutral" title="Feedback Case Study"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2016 <a href="https://www.deter-project.org/">DETER Project</a>.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../feedback/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../agent-configuration/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
