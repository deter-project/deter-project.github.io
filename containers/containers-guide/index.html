<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <title>Containers Guide - DETERLab Docs</title>
  

  <link rel="shortcut icon" href="../../favicon.ico">
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../css/extra.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Containers Guide";
    var mkdocs_page_input_path = "containers/containers-guide.md";
    var mkdocs_page_url = "/containers/containers-guide/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon">
          <!--REPLACE LOGO FILE HERE -->
          <img class="logo" style="float:left" src="/img/doc-logo.png"/> 
          <span class="title">DETERLab Docs</span></a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Welcome to the DETERLab Documentation</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../Glossary/">Glossary</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>DETERLab Core</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/core-quickstart/">Core Quickstart</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/core-guide/">Core Guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/sample-topologies/">Sample Topologies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/using-nodes/">Using Your Nodes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/generating-traffic/">Generating Traffic</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/link-delays/">End Node Traffic Shaping</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/sharing/">Using Shared Materials</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/user-guidelines/">User Do's and Don'ts</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Core Reference</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/deterlab-commands/">DETERLab Commands</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/ns-commands/">NS Commands Extensions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/swapping/">Understanding Swapping (Node Use Policies)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/DETERSSH/">Accessing testbeds using SSH</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/node-types/">DETERLab Node Types</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/serial-console/">Using the Serial Console</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/dell-serial-console/">Dell Serial Console</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/os-images/">OS Images</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/custom-images/">Creating Custom Images</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/windows/">Windows XP</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../core/legacy-tools/">Legacy Tools</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Orchestrator</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/orchestrator-quickstart/">Orchestrator Quickstart</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/orchestrator-guide/">Orchestrator Guide</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/orchestrator-case-studies/">Orchestrator Case Studies</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/simple-client-server/">Simple Client Server Case Study</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/scaled-client-server/">Scaled Client Server Case Study</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/feedback/">Feedback Case Study</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/writing-agents/">Specialized User</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/data-management/">Orchestrator Data Management</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/orchestrator-config/">MAGI Configuration</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/orchestrator-reference/">Orchestrator Reference</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/system-files/">MAGI System Organization</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/agent-library/">MAGI Agent Library</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/magi-tools/">MAGI Tools</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/magi-dev/">MAGI Development Codebase</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../orchestrator/magi-desktop/">MAGI Desktop</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Containers</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../containers-quickstart/">Containers Quickstart</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Containers Guide</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#basic-containers-tutorial">Basic Containers Tutorial</a></li>
                
                    <li><a class="toctree-l4" href="#getting-started">Getting started</a></li>
                
                    <li><a class="toctree-l4" href="#step-1-design-the-topology">Step 1: Design the topology</a></li>
                
                    <li><a class="toctree-l4" href="#step-2-create-the-containerized-experiment">Step 2: Create the containerized experiment</a></li>
                
                    <li><a class="toctree-l4" href="#step-3-swap-in-resources">Step 3: Swap-in resources</a></li>
                
                    <li><a class="toctree-l4" href="#step-4-verify-virtual-topology-and-access-nodes">Step 4: Verify virtual topology and access nodes</a></li>
                
                    <li><a class="toctree-l4" href="#step-4-releasing-resources">Step 4: Releasing Resources</a></li>
                
            
                <li class="toctree-l3"><a href="#advanced-topics">Advanced Topics</a></li>
                
                    <li><a class="toctree-l4" href="#using-other-container-types">Using Other Container Types</a></li>
                
                    <li><a class="toctree-l4" href="#mixing-containers">Mixing Containers</a></li>
                
                    <li><a class="toctree-l4" href="#setting-openvz-parameters">Setting Openvz Parameters</a></li>
                
                    <li><a class="toctree-l4" href="#setting-qemu-parameters">Setting Qemu Parameters</a></li>
                
                    <li><a class="toctree-l4" href="#changing-the-packing-factor">Changing The Packing Factor</a></li>
                
                    <li><a class="toctree-l4" href="#user-packing">User Packing</a></li>
                
                    <li><a class="toctree-l4" href="#more-sophisticated-packing-multiple-passes">More Sophisticated Packing: Multiple Passes</a></li>
                
            
                <li class="toctree-l3"><a href="#further-reading">Further Reading</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../containers-reference/">Containers Reference</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Other Features</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../federation/">Federation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../abac/">ABAC</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Education Materials</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/">Education Materials Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/guidelines-for-teachers/">Guidelines for Teachers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/class-support/">Class Support</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/course-setup/">Course Setup</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/good-teaching-practices/">Good Teaching Practices</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/connect-with-teachers/">Connect With Other Teachers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/guidelines-for-students/">Guidelines for Students</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/student-intro/">Student Introduction to DETERLab</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../education/public-materials/">Public Materials</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Miscellaneous</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../ISIUCB/">DETERLab Rooms</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">DETERLab Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Containers &raquo;</li>
        
      
    
    <li>Containers Guide</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>In this tutorial we walk you through setting up a basic containerized experiment. This page also includes common advanced topics. Detailed descriptions of the commands and configuration files are available in the <a href="/containers/containers-reference/">reference section</a>. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are a student, go to the <a href="http://education.deterlab.net">http://education.deterlab.net</a> site for classroom-specific instructions.</p>
</div>
<h2 id="basic-containers-tutorial">Basic Containers Tutorial<a class="headerlink" href="#basic-containers-tutorial" title="Permanent link"></a></h2>
<p>This tutorial will set up a containerized experiment with a star topology. We'll create a central node and connect 9 other nodes to it</p>
<h3 id="getting-started">Getting started<a class="headerlink" href="#getting-started" title="Permanent link"></a></h3>
<p>You will need a DETERLab account and be a member of a project. If you need help, see <a href="/core/core-guide/">the Core Guide</a>. </p>
<h3 id="step-1-design-the-topology">Step 1: Design the topology<a class="headerlink" href="#step-1-design-the-topology" title="Permanent link"></a></h3>
<p>First, we will describe a star topology.</p>
<p><img alt="Visualization of star topology" src="../../img/visualization-small.png" /></p>
<p>For this example we will use the standard DETER topology descriptions.  If you are new to designing topologies, walk through the basic tutorial in the <a href="/core/core-guide/">Core Guide</a>.  The Containers system is largely compatible with the physical DETER interface.</p>
<p>Download the <a href="/downloads/example1.tcl">DETERLab-compatible ns2 description of this topology at this link</a> to your home directory on <code>users.isi.deterlab.net</code>.  It is a simple loop, along with the standard DETER boilerplate.  This file will be used to create a 10-node (9 satellites and one central node) physical experiment on DETER, although there are not many physical nodes on DETER with 10 interfaces (one interface for control traffic).</p>
<p>The following is the topology description:</p>
<pre><code>    source tb_compat.tcl
    set ns [new Simulator]

    # Create the center node (named by its variable name)
    set center [$ns node]

    # Connect 9 satellites
    for { set i 0} { $i &lt; 9 } { incr i} {
        # Create node n-1 (tcl n($i) becomes n-$i in the experiment)
        set n($i) [$ns node]
        # Connect center to $n($i)
        ns duplex-link $center $n($i) 100Mb 10ms DropTail
    }

    # Creation boilerplate
    $ns rtptoto Static
    $ns run
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>The central node is named "center" and each satellite is names "n-0", "n-1"... through "n-8".  </li>
<li>Each connection is a 100 Mb/s link with a 10ms delay.  </li>
<li>The round trip time from n-0 to center will be 20 ms and from n-0 to n-1 will be 40 ms.</li>
</ul>
</div>
<h3 id="step-2-create-the-containerized-experiment">Step 2: Create the containerized experiment<a class="headerlink" href="#step-2-create-the-containerized-experiment" title="Permanent link"></a></h3>
<p>Now we will run a command so the Containers system will build the containerized experiment on top of a new DETERLab physical experiment.  </p>
<p>Run the following command from the shell on <code>users.isi.deterlab.net</code> and refer to the example topology you just saved in your home.  </p>
<pre><code>$ /share/containers/containerize.py DeterTest example1 ~/example1.tcl 
</code></pre>

<p>where the first two parameters are the project and experiment name to hold the DETER experiment.  </p>
<p>This command creates an experiment called <code>experiment1</code> in the <code>DeterTest</code> project. Throughout this tutorial, we will refer to your project as <em>DeterTest</em>, but make sure you actually use your actual project's name. You may use the experiment name <em>experiment1</em> as long as another experiment with that name doesn't already exist</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As with any DETERLab experiment, you must be a member of the project with appropriate rights to create an experiment in it.  <code>containerize.py</code> expects there to be no experiment with that name, and it will fail if one exists.  To remove an experiment you may terminate it through the web interface or use the <code>endexp</code> command.  Terminating an experiment is more final than swapping one out, so be sure that you want to replace the old experiment.  You may also resolve the conflict by renaming your new containerized experiment.</p>
</div>
<p>The last parameter is the file containing the topology.  In this tutorial, we are referring to the ns2 file in <a href="example1.tcl">our example</a> but you may also use a <a href="http://fedd.deterlab.net/wiki/TopDl">topdl</a> description.  An ns2 description must end in <code>.tcl</code> or <code>.ns</code>.</p>
<p>With these default parameters <code>containerize.py</code> will put each node into an <a href="http://openvz.org">Openvz container</a> with at most 10 containers per physical node.</p>
<p>The output of the above command should be something like the following:</p>
<pre><code>users:~$ /share/containers/containerize.py DeterTest example1 ~/example1.tcl 
Containerized experiment DeterTest/example1 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example1
</code></pre>

<p>Now we can see what a containerized experiment looks like.</p>
<h4 id="the-contents-of-a-containerized-experiment">The Contents of a Containerized Experiment<a class="headerlink" href="#the-contents-of-a-containerized-experiment" title="Permanent link"></a></h4>
<p>Follow the link provided in the <code>containerize.py</code> output. You will see a standard DETER experiment page that looks like this:</p>
<p><img alt="Screenshot of the Experiment page" src="../../img/experiment-page.png" /></p>
<p>You may be surprised to see that DETER thinks the experiment has only one node:</p>
<p><img alt="Highlighting single-node visualization" src="../../img/hilighted.png" /></p>
<p>The Containers system has rewritten the description file and stored additional information in the experiment's per-experiment directory that will be used to create the 10 node experiment inside the single-node DETER experiment.  </p>
<p>If you look at the ns file DETERLab has stored (click the <em>NS File</em> tab on the experiment page), you should see the following code:</p>
<pre><code>set ns [new Simulator]
source tb_compat.tcl

tb-make-soft-vtype container0 {pc2133 bpc2133 MicroCloud}
set pnode(0000) [$ns node]
tb-set-node-os ${pnode(0000)} CentOS6-64-openvz
tb-set-hardware ${pnode(0000)} container0
tb-set-node-startcmd ${pnode(0000)} &quot;sudo /share/containers/setup/hv/bootstrap /proj/DeterTest/exp/example1/containers/site.conf &gt;&amp; /tmp/container.log&quot;
tb-set-node-failure-action ${pnode(0000)} &quot;nonfatal&quot;

$ns rtproto Static
$ns run
</code></pre>

<p>This looks nothing like the file we gave to <code>containerize.py</code>, but it does show us a little about what the Containers system has done:</p>
<ul>
<li>The single physical node (<code>pnode(0000)</code>) will run the <code>CentOS6-64-openvz</code> image and run on a few kinds of node.  </li>
<li>On startup, <code>pnode(0000)</code> will execute a command from the same <code>/share/containers</code> directory that <code>containerize.py</code> ran from using data in the per-experiment directory <code>/proj/DeterTest/exp/example1/containers/site.conf</code>.</li>
<li>There is a separate <code>/proj/DeterTest/exp/example1/containers/</code> directory for each experiment.  The path element after <code>/proj</code> is replaced with the project under which the experiment was created -- <code>DeterTest</code> in this example -- and the element after <code>exp</code> is the experiment name -- <code>example1</code> in this case.  These directories are created for all DETERLab experiments.  </li>
</ul>
<h4 id="containers-sub-directory"><code>containers</code> sub-directory<a class="headerlink" href="#containers-sub-directory" title="Permanent link"></a></h4>
<p>The <code>containers</code> sub-directory of a containerized experiment holds information specific to a containerized experiment. There are a few useful bits of data in that per-experiment containers directory that we can look at.</p>
<ul>
<li><strong>Copy of the topology file:</strong> First, a copy of the topology that we gave to <code>containerize.py</code> is available in <code>/proj/DeterTest/exp/example1/containers/experiment.tcl</code>.  If the experiment is created from a topdl file, the filename will be <code>containers/experiment.tcl</code>.</li>
<li><strong>Visualization of experiment:</strong> A simple visualization of the experiment is in <code>containers/visualization.png</code>.  This is annotated with node and network names as well as interface IP addresses.  The topology depiction <a href="/containers/containers-guide/#step-1-design-the-topology">above</a> is an example.  To view a <a href="/img/visualization.png">larger version, click here</a>.</li>
<li><strong>IP-to-hostname mapping:</strong> The <code>containers/hosts</code> file is a copy of the IP-to-hostname mapping found on each virtual machine in the topology.  It can be useful in converting IP addresses back to names.  It is installed in <code>/etc/hosts</code> or the equivalent on each machine.</li>
<li><strong>PID/EID:</strong> The two files <code>/var/containers/pid</code> and <code>/var/containers/eid</code> contain the project name and experiment name.  Scripts can make use of these.</li>
</ul>
<p>The rest of the contents of that directory are primarily used internally by the implementation, but a more detailed listing is in the <a href="/containers/containers-reference/#Per-experimentDirectory">Containers Reference</a>.</p>
<h3 id="step-3-swap-in-resources">Step 3: Swap-in resources<a class="headerlink" href="#step-3-swap-in-resources" title="Permanent link"></a></h3>
<p>At this point, as with any DETER experiment, the topology does not yet have any resources attached.  To get the resources, swap the experiment in from the web interface or using the <code>swapexp</code> command. See the <a href="/core/core-guide/">DETERLab Core Guide</a> for more information.</p>
<h3 id="step-4-verify-virtual-topology-and-access-nodes">Step 4: Verify virtual topology and access nodes<a class="headerlink" href="#step-4-verify-virtual-topology-and-access-nodes" title="Permanent link"></a></h3>
<p>Once you have been notified that the physical experiment has finished its swap-in, the Containers system starts converting the physical topology into the virtual topology. </p>
<p>At this time, you must manually verify when the virtual topology has been created by ping-ing or trying to SSH into individual nodes of an experiment. There is also a <a href="/containers/containers-guide/#StartCommands">workaround suggested below</a>. We are working towards offering a better notification system.</p>
<p>Once the containerized elements have all started, the nodes are available as if they were physical nodes.  For example, we may access node <code>n-0</code> of the experiment we swapped in by running:</p>
<pre><code>$ ssh n-0.example1.detertest
</code></pre>

<p>Be sure that you replace <code>example1</code> with the experiment name you passed to <code>containerize.py</code> and <code>DeterTest</code> with the project you created the experiment under.  This is a DNS name, so it is case-insensitive.</p>
<p>When the SSH succeeds, you will have access to an Ubuntu 10.04 32-bit node with the same directories mounted as in a physical DETERLab experiment. Containerized nodes access the control net as well. Your home directory will be mounted, so your SSH keys will work for accessing the machine.</p>
<p>Use the <a href="/core/using-nodes/#hostnames-for-your-nodes">same node naming conventions</a> as physical DETERLab experiments to ping and access other nodes.</p>
<p>Here is a ping from <code>n-0</code> to <code>center</code> and <code>n-1</code> that confirms the containerized experiment is working as we expect.</p>
<pre><code>n-0:~$ ping -c 3 center
PING center-tblink-l21 (10.0.0.2) 56(84) bytes of data.
64 bytes from center-tblink-l21 (10.0.0.2): icmp_seq=1 ttl=64 time=20.4 ms
64 bytes from center-tblink-l21 (10.0.0.2): icmp_seq=2 ttl=64 time=20.0 ms
64 bytes from center-tblink-l21 (10.0.0.2): icmp_seq=3 ttl=64 time=20.0 ms

--- center-tblink-l21 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2002ms
rtt min/avg/max/mdev = 20.052/20.184/20.445/0.184 ms
n-0:~$ ping -c 3 n-1
PING n-1-tblink-l5 (10.0.6.1) 56(84) bytes of data.
64 bytes from n-1-tblink-l5 (10.0.6.1): icmp_seq=1 ttl=64 time=40.7 ms
64 bytes from n-1-tblink-l5 (10.0.6.1): icmp_seq=2 ttl=64 time=40.0 ms
64 bytes from n-1-tblink-l5 (10.0.6.1): icmp_seq=3 ttl=64 time=40.0 ms

--- n-1-tblink-l5 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 40.094/40.318/40.764/0.355 ms
</code></pre>

<p>The nodes have the expected round trip times.</p>
<p>At this point you can load and run software and generally experiment normally.</p>
<h4 id="start-commands">Start Commands<a class="headerlink" href="#start-commands" title="Permanent link"></a></h4>
<p>DETERLab Core provides a facility to run a command when a physical experiment starts, called <a href="/core/core-guide/#starting-your-application-automatically">start commands</a>.  A containerized experiment offers a similar facility with a few differences:</p>
<ul>
<li>The start commands are not coordinated across nodes.  In a physical experiment, the start commands all execute when the last node has reported to the testbed that it has completed booting.  In a containerized experiment, the start commands run when the containerized node has come up.</li>
<li>Logs from the start command are available in <code>/var/containers/log/start_command.out</code> and <code>/var/containers/log/start_command.err</code>.  This is true on embedded pnodes as well.</li>
<li>Start commands must be shorter than in a physical experiment because the Containers system is also using the facility.</li>
<li>The event system cannot be used to replay the start command.</li>
</ul>
<div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>While start commands that make use of shell syntax for multiple commands and simple file redirection (e.g, &gt; or &lt;) may work, errors parsing redirection or other shell commands will cause the start command to <strong>fail silently</strong>.  If you are doing anything more complex than calling a single program, we recommend that you create a simple script and run the script from the per-experiment directory or your home directory.  This makes it more likely that the log files created by containers will have useful debugging information.</li>
<li><strong>We strongly recommend removing all shell redirection characters from the text of your start command.</strong>  Redirecting I/O in the text of the start command may <strong>fail silently</strong>.</li>
</ul>
</div>
<p>Start commands offer a simple workaround for detecting that all nodes in an experiment have started:</p>
<pre><code>    #!/bin/sh

    STARTDIR=&quot;/proj/&quot;`cat /var/containers/pid`&quot;/exp/&quot;`cat /var/containers/eid`&quot;/startup&quot;

    mkdir $STARTDIR
    date &gt; $STARTDIR/`hostname`
</code></pre>

<p>If you make the script above the start command of all nodes, the Containers system will put the time that each local container came up in the <code>startup</code> directory under the per-experiment directories.  For example, <code>n-0.example1.DeterTest</code> will create <code>/proj/DeterTest/exp/example1/startup/n-0</code>.  Then you may monitor that directory on <code>users</code> to know which nodes are up.</p>
<h3 id="step-4-releasing-resources">Step 4: Releasing Resources<a class="headerlink" href="#step-4-releasing-resources" title="Permanent link"></a></h3>
<p>As with a physical DETER experiment, release resources by swapping the experiment out using the web interface or the <code>swapexp</code> command (see the <a href="/core/core-guide/">Core Guide</a> for more information.  If you are using the <a href="/containers/containers-guide/#StartCommands">startcommand workaround</a> to detect startup, clear the startup directory when you swap the experiment out.</p>
<h2 id="advanced-topics">Advanced Topics<a class="headerlink" href="#advanced-topics" title="Permanent link"></a></h2>
<p>The previous tutorial described how to create an experiment using only openvz containers packed 10 to a machine.  This section describes how to change those parameters.</p>
<h3 id="using-other-container-types">Using Other Container Types<a class="headerlink" href="#using-other-container-types" title="Permanent link"></a></h3>
<p>To change the container type that <code>containerize.py</code> assigns to nodes, use the <code>--default-container</code> option.  Valid choices follow the [ContainersQuickstart#KindsofContainers kinds of containers] DETERLab supports.  Specifically:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Container</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>embedded_pnode</code></td>
<td>Physical Node</td>
</tr>
<tr>
<td><code>qemu</code></td>
<td>Qemu VM</td>
</tr>
<tr>
<td><code>openvz</code></td>
<td>Openvz Container</td>
</tr>
<tr>
<td><code>process</code></td>
<td>ViewOS process</td>
</tr>
</tbody>
</table>
<p>You can try this on our <a href="/downloads/example1.tcl">example topology</a>:</p>
<pre><code>users:~$ /share/containers/containerize.py --default-container qemu DeterTest example2 ~/example1.tcl 

Requested a QEMU node with more than 7 experimental interfaces.  Qemu nodes
can only support 7 experimental interfaces.
</code></pre>

<p>The Containers system is now using qemu containers to build our experiment.  Unfortunately qemu containers only support 7 experimental interfaces, an internal limit on the number of interfaces the virtual hardware supports.  Run the command again but use the attached <a href="/downloads/example2.tcl"</a>version of the topology with fewer satellites</a> to containerize without error.</p>
<pre><code>$ /share/containers/containerize.py --default-container qemu DeterTest example2 ~/example2.tcl 
Containerized experiment DeterTest/example2 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example2
</code></pre>

<p>The qemu experiment looks much like the openvz experiment above, at this small scale.  Qemu nodes more completely emulate hardware and the kernels are independent, unlike openvz containers.  For example, a program can load kernel modules in a qemu VM, which it cannot do in an openvz container.  The qemu containers load the Ubuntu 12.04 (32 bit) distribution by default.</p>
<p>We can also swap in the experiment using ViewOS processes, but processes cannot be manipulated from outside.  They are too lightweight to allow an SSH login, though they will run a start command.</p>
<h3 id="mixing-containers">Mixing Containers<a class="headerlink" href="#mixing-containers" title="Permanent link"></a></h3>
<p>Mixing containers requires you to assign container types in the topology description.  This is done by attaching an attribute to nodes.  The attribute is named <code>containers:node_type</code> and it takes the same values as the <a href="/containers/containers-guide#UsingOtherContainerTypes">--default-container parameter to containerize.py</a>.  If the experiment definition is in <a href="http://fedd.isi.deterlab.net/wiki/TopDl">topdl</a>, the attribute can be attached using the <a href="http://fedd.deterlab.net/wiki/TopdlLibrary#SharedFunctions">standard topdl routines</a>.  Attaching the attribute in ns2 is done using the DETERLab <code>tb-add-node-attribute</code> command.</p>
<pre><code>tb-add-node-attribute $node containers:node_type openvz
</code></pre>

<p>Using this command in an ns2 topology description will set <code>node</code> to be placed in an openvz container.  Using this feature, we can modify our <a href="/downloads/example1.tcl">first example topology</a> to consist of qemu nodes and a single process container in the center.  Process nodes can have unlimited interfaces, but we cannot log into them.  The <a href="/downloads/example3.tcl">new topology file</a> looks like this:</p>
<pre><code>    source tb_compat.tcl
    set ns [new Simulator]

    # Create the center node (named by its variable name)
    set center [$ns node]
    # The center node is a process
    tb-add-node-attribute $center containers:node_type process

    # Connect 9 satellites
    for { set i 0} { $i &lt; 9 } { incr i} {
        # Create node n-1 (tcl n($i) becomes n-$i in the experiment)
        set n($i) [$ns node]
        # Satellites are qemu nodes
        tb-add-node-attribute $n($i) containers:node_type qemu
        # Connect center to $n($i)
        ns duplex-link $center $n($i) 100Mb 10ms DropTail
    }

    # Creation boilerplate
    $ns rtptoto Static
    $ns run
</code></pre>

<p>Because we have explicitly set the <code>container_node_type</code> of each node, the <code>--default-container</code> parameter to <code>containerize.py</code> does nothing.  Create this experiment by running:</p>
<pre><code>users:~$ /share/containers/containerize.py  DeterTest example3 ~/example3.tcl 
Containerized experiment DeterTest/example3 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example3
</code></pre>

<p>When we swap it in, the experiment will have 10 satellite containers in qemu VMs and a central process that only forwards packets.  Again, you cannot log in to a process container, but you can use the qemu nodes as though they were physical machines.</p>
<p>Another interesting mixture of containers is to include a physical node.  Here is a <a href="example4.tcl">modified version of our mixed topology</a> that places the <code>n-8</code> satellite on a physical computer by setting its <code>containers:node_type</code> to <code>embedded_pnode</code>.</p>
<p>After running that experiment you should have output similar to the following:</p>
<pre><code>users:~$ /share/containers/containerize.py  DeterTest example4 ~/example4.tcl
Containerized experiment DeterTest/example4 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example4
</code></pre>

<p>Follow the url to the DETERLab experiment page and look at the <em>Visualization</em> tab:</p>
<p><img alt="Screenshot of the Visualization tab for this experiment" src="../../img/embedded_pnode.png" /></p>
<p>The physical node <code>n-8</code> shows up in the DETERLab visualization and otherwise acts as a physical node that is in a 10-node topology.  This experiment uses three different container types: physical nodes, ViewOS processes, and Qemu VMs.</p>
<h4 id="limitations-on-mixing-containers">Limitations on Mixing Containers<a class="headerlink" href="#limitations-on-mixing-containers" title="Permanent link"></a></h4>
<p>At the moment, Qemu VMs and ViewOS processes are the only containers that can share a physical node.  Physical node containers are mapped one-to-one to physical nodes by definition.  Qemu and OpenVZ use different underlying operating system images in DETERLab, therefore they cannot share physical hardware.  Neither ViewOS processes nor Qemu VMs can share a physical machine with OpenVZ VMs.</p>
<p>The first invocation of <code>tb-add-node-attribute</code> takes precedence.  It is best to only call <code>tb-add-node-attribute</code> once per attribute assigned on each node.</p>
<h3 id="setting-openvz-parameters">Setting Openvz Parameters<a class="headerlink" href="#setting-openvz-parameters" title="Permanent link"></a></h3>
<p>An advantage of openvz nodes is that you can set the OS flavor and CPU bit-width across experiments and per-node.  Similarly, you can set the size of the disk allocated to each node.  </p>
<p>Openvz uses templates to look like various Linux installations.  The choices of Linux distribution that openvz supports are:</p>
<table>
<thead>
<tr>
<th>Template</th>
<th>Distribution</th>
<th>Bit-width</th>
</tr>
</thead>
<tbody>
<tr>
<td>centos-6-x86</td>
<td>CentOS 6</td>
<td>32 bit</td>
</tr>
<tr>
<td>centos-6-x86_64</td>
<td>CentOS 6</td>
<td>64 bit</td>
</tr>
<tr>
<td>ubuntu-10.04-x86</td>
<td>Ubuntu 10.04 LTS</td>
<td>32 bit</td>
</tr>
<tr>
<td>ubuntu-10.04-x86_64</td>
<td>Ubuntu 10.04 LTS</td>
<td>64 bit</td>
</tr>
<tr>
<td>ubuntu-12.04-x86</td>
<td>Ubuntu 12.04 LTS</td>
<td>32 bit</td>
</tr>
<tr>
<td>ubuntu-12.04-x86_64</td>
<td>Ubuntu 12.04 LTS</td>
<td>64 bit</td>
</tr>
</tbody>
</table>
<p>The default template is <code>ubuntu-10.04-x86</code>.</p>
<p>To set a template across an entire topology, give <code>--openvz-template</code> and the template name from the list above.  Invoking <code>containerize.py</code> on <a href="/downloads/example1.tcl">our original example</a> as below will instantiate the experiment under 64-bit Ubuntu 12.04:</p>
<pre><code>users:~$ /share/containers/containerize.py --openvz-template ubuntu-12.04-x86_64 DeterTest example1 ~/example1.tcl 
Containerized experiment DeterTest/example1 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example1
</code></pre>

<p>To set the size of the file system of containers in the experiment, use <code>--openvz-diskspace</code>.  The value of the parameter is determined by the suffix:</p>
<table>
<thead>
<tr>
<th>Suffix</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>G</td>
<td>Gigabytes</td>
</tr>
<tr>
<td>M</td>
<td>Megabytes</td>
</tr>
</tbody>
</table>
<p>The default openvz file system size is 2GB.</p>
<p>The most practical suffix for DETERLab nodes is "G":</p>
<pre><code>users:~$ /share/containers/containerize.py --openvz-diskspace 15G DeterTest example1 ~/example1.tcl 
Containerized experiment DeterTest/example1 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example1
</code></pre>

<p>Each of these parameters can be set on individual nodes using attributes.  Use <code>containers:openvz_template</code> to set a template on a node and use <code>containers:openvz_diskspace</code> to set the disk space. <a href="/downloads/example5.tcl">This example topology</a> sets these openvz parameters per node:</p>
<pre><code>    source tb_compat.tcl
    set ns [new Simulator]

    # Create the center node (named by its variable name)
    set center [$ns node]
    # The center node is a process
    tb-add-node-attribute $center containers:node_type process
    tb-add-node-attribute $center containers:openvz_template ubuntu-12.04-x86_64

    # Connect 9 satellites
    for { set i 0} { $i &lt; 9 } { incr i} {
        # Create node n-1 (tcl n($i) becomes n-$i in the experiment)
        set n($i) [$ns node]
        # Set satellite disk sizes to be 20 GB
        tb-add-node-attribute $n($i) containers:openvz_diskspace 20G
        # Connect center to $n($i)
        ns duplex-link $center $n($i) 100Mb 10ms DropTail
    }

    # Creation boilerplate
    $ns rtptoto Static
    $ns run
</code></pre>

<p>The <code>center</code> node will run Ubuntu 12.04 64 bit and the satellites will have 20GB file systems.</p>
<h3 id="setting-qemu-parameters">Setting Qemu Parameters<a class="headerlink" href="#setting-qemu-parameters" title="Permanent link"></a></h3>
<p>The Containers system has a more limited ability to set qemu parameters.  Right now, a custom image may be loaded using the <code>containers::qemu_url</code> attribute and the architecture of the qemu VM may be chosen using <code>containers:qemu_arch</code>.  Valid qemu architectures are:</p>
<table>
<thead>
<tr>
<th>Param</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>i386</td>
<td>32 bit Intel</td>
</tr>
<tr>
<td>x86_64</td>
<td>64-bit Intel</td>
</tr>
</tbody>
</table>
<p>The image URL must be reachable from inside DETERLab.  The image must be a qcow2 image, optionally bzip2ed.  Facilities to snapshot and store such images are in development.</p>
<p>If you are using a qemu image that is not booting into containers, make sure <a href="/containers/containers-reference/#BootableQemuImages">grub is properly configured</a>.</p>
<p>Qemu images also mount users' home directories the same as DETERLab physical nodes do.  In order to do this scalably, the Qemu VMs mount the users' directories from the physical node.  The DETER infrastructure cannot support exporting users' directories to thousands of containers.</p>
<p>However, a Qemu VM can only mount a few tens of user directories this way.  The limit is 23 user directories (24 in experiments that are not instantiated in a group).  Many projects have more than 23 users, but in practice only a few experimenters need access to the containers.</p>
<p>To tell the Containers systems which user to mount, use the <code>--qemu-prefer-users</code> option to <code>containerize.py</code>.  That option takes a comma-separated list of usernames (no spaces).  When the Qemu nodes will always mount those users' home directories.  Others will be mounted if there is room.</p>
<p>For example:</p>
<pre><code>users:~$ /share/containers/containerize.py  --qemu-prefer-users=faber,jjh DeterTest example4 ~/example4.tcl
</code></pre>

<p>This command makes sure that users <code>faber</code> and <code>jjh</code> have their home directories mounted in any Qemu containers.</p>
<h3 id="changing-the-packing-factor">Changing The Packing Factor<a class="headerlink" href="#changing-the-packing-factor" title="Permanent link"></a></h3>
<p>The <code>containerize.py</code> program decides how many virtual nodes to put on each physical machine.  Because we have been using roughly the same number of nodes as the default packing target (10 nodes per machine) all of the examples so far have fit onto a single machine.  If we change the packing factor by using the <code>--packing</code> parameter to <code>containerize.py</code>, we can put fewer nodes on each machine.  For example:</p>
<pre><code>users:~$ /share/containers/containerize.py --packing 2 DeterTest example1 ~/example1.tcl 
Containerized experiment DeterTest/example1 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example1
</code></pre>

<p>This command calls <code>containerize.py</code> on our <a href="/downloads/example1.tcl">original topology</a> with a low packing factor.  The result is the same nodes spread across more physical machines, as we can see from the DETERLab web interface (on the <em>Visualization</em> tab):</p>
<p><img alt="Screenshot of the Visualization tab for this experiment" src="../../img/loose.png" /></p>
<p>You will want to balance how many physical machines you use against how precisely you want to mimic them.</p>
<h3 id="user-packing">User Packing<a class="headerlink" href="#user-packing" title="Permanent link"></a></h3>
<p>You may specify your own packing using the <code>containers:partition</code> attribute.  This attribute must be assigned an integer value. All nodes with the same partition are allocated to the same machine.  If nodes have that attribute attached to them, <code>containers.py</code> will assume that they all have been partitioned and use those.  Nodes without a partition assigned are assumed to be <code>embedded_pnode</code>s.</p>
<h3 id="more-sophisticated-packing-multiple-passes">More Sophisticated Packing: Multiple Passes<a class="headerlink" href="#more-sophisticated-packing-multiple-passes" title="Permanent link"></a></h3>
<p>The previous examples have all treated packing containers onto physical machines as a single-step process with a single parameter - the packing factor.  In fact, we can divide containers into sets and pack each set independently using different parameters.  </p>
<p>For example in an experiment with many containers dedicated only to forwarding packets and a few to modeling servers, we could create two sets and pack the forwarders tightly (using a high packing factor) and the servers loosely.</p>
<p>In exchange for providing greater control on packing, there is a price.  When a <em>set</em> of containers is packed, the Containers system takes into account both the nodes to be packed and their interconnections.  When <em>subsets</em> of containers are packed, the system cannot consider the interconnections between subsets.  In some cases, the packing of subsets can lead to a DETERLab experiment that cannot be created successfully.  This danger is mitigated by the fact that containers that are packed together are often related in ways that limit the number of connections between that set and another.</p>
<p>To explore packing, we need to use a <a href="/downloads/example6.tcl">larger topology</a>:</p>
<pre><code>    source tb_compat.tcl
    set ns [new Simulator]

    set center [$ns node]
    tb-add-node-attribute $center &quot;containers:PartitionPass&quot; 0


    for { set i 0} { $i &lt; 3 } { incr i} {
        set lanlist $center
        for { set j 0 } { $j &lt; 20} { incr j } {
            set idx [expr $i * 20 + $j]
            set n($idx) [$ns node]
            tb-add-node-attribute $n($idx) &quot;containers:PartitionPass&quot; [expr $i + 1]
            lappend lanlist $n($idx)
        }
        set lan($i) [$ns make-lan [join $lanlist &quot; &quot;] 100Mb 0]
    }

    # Creation boilerplate
    $ns rtptoto Static
    $ns run
</code></pre>

<p>This creates three 20-node sub networks attached to a single central router.  It looks like this:</p>
<p><img alt="Visualization of three 20-node subnetworks attached to a single central router" src="../../img/packing-small.png" /></p>
<p>Each node in the topology is assigned a <code>containers::PackingPass</code> attribute that groups them into subsets.  The <code>containers:PackingPass</code> attribute must be assigned an integer value.  The nodes in each packing pass are considered "together" when packing.  Each pass can be assigned different parameters.  The passes are carried out in order, though that is rarely important.</p>
<p>Our example topology assigns <code>center</code> to pass 0, the nodes on <code>lan-0</code> (the tcl variable lan(0)) to pass 1, those on <code>lan-1</code> to pass 2 and those on <code>lan-2</code> to pass 3.  We will use the <code>--pass-pack</code> parameter to specify the packing factor for each pass.  Each packing factor specification looks like <em>pass</em>:<em>factor</em> where pass and factor are both integers.  We can specify more than one, separated by commas, or specify <code>--pass-pack</code> more than once.</p>
<p>For example, we can pack the experiment using the following factors:</p>
<table>
<thead>
<tr>
<th>Pass</th>
<th>Packing Factor</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>20</td>
</tr>
<tr>
<td>2</td>
<td>10</td>
</tr>
<tr>
<td>3</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>By issuing the following command:</p>
<pre><code>users:~$ /share/containers/containerize.py --pass-pack 0:1,1:20,2:10,3:5 DeterTest example6 ~/example6.tcl 
Containerized experiment DeterTest/example6 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example6
</code></pre>

<p>We can view the packing by using <code>container_image.py</code> to generate a visualization that includes the partitions:</p>
<pre><code>users:~$ /share/containers/container_image.py --experiment DeterTest/example6 --partitions --out ~/example6.png
</code></pre>

<p>The output shows the topology with boxes drawn around the containers that share a physical node:</p>
<p><img alt="Indicates containers in this topology" src="../../img/example6-smaller.png" /></p>
<p>That partitioning is surprising in that <code>lan-1</code> is split into three partitions of 6 &amp; 7 nodes rather than two partitions of 10.  Similarly <code>lan-2</code> is split into five groups of 4 rather than four groups of 5.  </p>
<p>The packing system is built on the <a href="http://glaros.dtc.umn.edu/gkhome/metis/metis/overview">metis</a> graph partitioning software.  Metis takes a graph and a number of partitions and finds the most balanced partitioning that has roughly equal node counts in each partition as well as low inter-partition communication costs.  The Containers system calls metis with increasing numbers of partitions until a partitioning is found that meets the packing factor limits.</p>
<p>When the system attempts to pack <code>lan-1</code> into two partitions, metis balances the node counts and the communications costs to produce a partition with 9 containers in one machine and 11 on the other.  That partitioning does not meet the 10 node limit, so it tries again with three partitions and succeeds.</p>
<p>There are two ways to fit our topology onto fewer nodes.  The first is to put slightly more slop into the packing factors:</p>
<table>
<thead>
<tr>
<th>Pass</th>
<th>Packing Factor</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>20</td>
</tr>
<tr>
<td>2</td>
<td>11</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
</tr>
</tbody>
</table>
<p>As in the following command:</p>
<pre><code>users:~$ /share/containers/containerize.py --pass-pack 0:1,1:20,2:11,3:6 DeterTest example6 ~/example6.tcl 
Containerized experiment DeterTest/example6 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example6
</code></pre>

<p>These parameters result in this packing, which fits in fewer nodes, but has the slight imbalances of splitting <code>lan-1</code> into 9 and 11 containers and <code>lan-2</code> into 4,5,and 6 container partitions.  Again, this asymmetry is an attempt to consider the internode networking costs.</p>
<p><img alt="Visualization of packing in fewer nodes" src="../../img/example6.2-smaller.png" /></p>
<p>If the packing constraints are exact - 11 containers on <code>lan-1</code> is unacceptable - a second choice is to use the <code>--nodes-only</code> option.  This sets the cost of each arc in the graph to 0.  Metis ignores such arcs altogether, so the partitions are completely even.  This may cause trouble in more complex network topologies.</p>
<p>The result of running the command with the original packing factors and <code>--nodes-only</code>):</p>
<pre><code>users:~$ /share/containers/containerize.py --nodes-only --pass-pack 0:1,1:20,2:10,3:5 DeterTest example6 ~/example6.tcl 
Containerized experiment DeterTest/example6 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example6
</code></pre>

<p>is</p>
<p><img alt="How the topology looks when packing only nodes" src="../../img/example6.3-smaller.png" /></p>
<p>which has symmetric partitions.</p>
<p>Sometimes it is more intuitive to think in terms of the number of machines that will be used to hold containers.  The <code>--size</code> and <code>-pass-size</code> options let users express that.  The <code>--size=</code><em>expsize</em> option uses <em>expsize</em> machines to hold the whole experiment.  If multiple passes are made, each is put into <em>expsize</em> physical machines.  The <code>--size</code> option takes precedence over <code>--packing</code>.</p>
<p>Per-pass sizing can be done using <code>--pass-size</code> which uses the same syntax as <code>--pass-pack</code>.  Therefore the command:</p>
<pre><code>users:~$ /share/containers/containerize.py --pass-size 0:1,1:1,2:2,3:4 DeterTest example6 ~/example6.tcl 
Containerized experiment DeterTest/example6 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example6
</code></pre>

<p>packs pass 0 into one physical machine, pass 1 into one physical machine, pass 2 into two physical machines and pass 3 into four physcial machines.  The result looks like:</p>
<p><img alt="How the topology looks using per-pass sizing" src="../../img/example6.2-smaller.png" /></p>
<p>Partitions have different numbers of containers in them because metis is considering network constraints as well.  As with using packing, adding <code>--nodes-only</code> restores symmetry:</p>
<p><img alt="How the toplogy looks using nodes only for per-pass sizing" src="../../img/example6.3-smaller.png" /></p>
<p>The <code>--pass-pack</code> option is a per-pass generalization of the <code>--packing</code> option.  The options that can be specified per-pass are:</p>
<table>
<thead>
<tr>
<th>Single-pass</th>
<th>Per-Pass</th>
<th>Per-Pass Format</th>
<th>Per-Pass Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--packing</code></td>
<td><code>--pass-pack</code></td>
<td><em>pass</em>:<em>packing</em>  (comma-separated)</td>
<td>--pass-pack 0:1,1:20,2:11,3:6</td>
</tr>
<tr>
<td><code>--size</code></td>
<td><code>--pass-size</code></td>
<td><em>pass</em>:<em>size</em>  (comma-separated)</td>
<td>--pass-size 0:1,1:1,2:2,3:4</td>
</tr>
<tr>
<td><code>--pnode-types</code></td>
<td><code>--pass-pnodes</code></td>
<td><em>pass</em>:<em>pnode</em>[,<em>pnode</em>...] (semicolon separated)</td>
<td>--pass-pnodes 0:MicroCloud;1:bpc2133,pc2133</td>
</tr>
<tr>
<td><code>--nodes-only</code></td>
<td><code>--pass-nodes-only</code></td>
<td><em>pass</em> (comma-separated)</td>
<td>--pass-nodes-only 1,3,5</td>
</tr>
</tbody>
</table>
<p>The single-pass version sets a default so that this invocation on <a href="/downloads/example6.tcl">our 4 pass topology</a>:</p>
<pre><code>users:~$ /share/containers/containerize.py --packing 5 --pass-pack 0:1,1:20 DeterTest example6 ~/example6.tcl 
Containerized experiment DeterTest/example6 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example6
</code></pre>

<p>will pack pass 0 with a factor of 1, pass 1 with a factor of 20 and passes 2 and 3 with a factor of 5.</p>
<p>Similarly:</p>
<pre><code>users:~$ /share/containers/containerize.py --pass-pack 0:1,1:20,2:10,3:5 --pass-pnodes '0:pc2133,bpc2133;1:MicroCloud' DeterTest example6 ~/example6.tcl 
Containerized experiment DeterTest/example6 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example6
</code></pre>

<p>will allocate either bpc2133 or pc2133 nodes to containers assigned by pass 0 and Microcloud physical nodes to the containers partitioned in pass 1.  The rest will be allocated as the <a href="/containers/containers-reference/#SiteConfigurationFile">site configuration</a> specifies.  The single quotes around the <code>--pass-pnodes</code> option protects the semi-colon from the shell.  Another choice is to specify the command as:</p>
<pre><code>users:~$ /share/containers/containerize.py --pass-pack 0:1,1:20,2:10,3:5 --pass-pnodes 0:pc2133,bpc2133 --pass-pnodes 1:MicroCloud DeterTest example6 ~/example6.tcl 
</code></pre>

<p>That formulation avoids the quotes by avoiding the semicolon.  All the per-pass options may be specified multiple times on the command line.</p>
<p>You can mix and match sizes and packing factors.  This invocation:</p>
<pre><code>/share/containers/containerize.py --pass-size 1:10 --pass-pack 2:5,3:10 DeterTest example6 ~/example6.tcl
Containerized experiment DeterTest/example6 successfully created!
Access it via http://www.isi.deterlab.net//showexp.php3?pid=DeterTest&amp;eid=example6
</code></pre>

<p>Produces:</p>
<p><img alt="An example of mixing and matching sizes and packing factors" src="../../img/example6.4-smaller.png" /></p>
<p>Remember that <code>--size</code> sets a default pass size and that sizes have precedence over packing.  If you specify <code>--size</code>, no <code>--packing</code> or <code>--pass-packing</code> value will take effect.  To mix packing and sizes, use <code>--pack-size</code> for each sized pass, rather than <code>--size</code>.</p>
<p>These per-pass variables and user-specified pass specifications give users fine grained control over the paritioning process, even if they do not want to do the partitioning themselves.</p>
<p>If no <code>containers:PartitionPass</code> attributes are specified in the topology, and no <code>containers:Partition</code> attributes are specified either, ```containerize.py}} carries out -- at most -- two passes.  Pass 0 paritions all openvz containers and pass 1 partitions all qemu and process containers.</p>
<h2 id="further-reading">Further Reading<a class="headerlink" href="#further-reading" title="Permanent link"></a></h2>
<p>Hopefully these illustrative examples have given you an idea of how to use the containers system and what it is capable of.  More details are available from <a href="/containers/containers-reference/">the reference guide</a>.  Please see <a href="https://trac.deterlab.net/wiki/GettingHelp"> Getting Help</a> if you have difficulties.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../containers-reference/" class="btn btn-neutral float-right" title="Containers Reference">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../containers-quickstart/" class="btn btn-neutral" title="Containers Quickstart"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2016 <a href="https://www.deter-project.org/">DETER Project</a>.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../containers-quickstart/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../containers-reference/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
  <!-- this makes the active part of the navigation sidebar scroll to top -->
<script type="text/javascript">
$(document).ready(function () {

  if ($("a").hasClass("current")) {
    var container = $("nav"),
    scrollTo = $("a.current");

    container.scrollTop(
    scrollTo.offset().top - container.offset().top + container.scrollTop() - 120
    );
    
    }
});
</script>
</body>
</html>
